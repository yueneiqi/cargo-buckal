# libra Integration Test - Generate Buck2 files and validate builds across platforms
#
# This workflow:
# 1. Generates Buck2 files on 3 platforms (linux/macos/windows)
# 2. For each of 8 target platforms, tests against ALL 3 generated file sets
#
# Total: 3 generation jobs + 24 test jobs (8 targets × 3 gen platforms)

name: libra Integration Test

on:
  pull_request:
  workflow_dispatch:
    inputs:
      debug_enabled:
        type: boolean
        description: 'Run with tmate debug (manual only)'
        required: false
        default: false
      enable_mingw_jobs:
        type: boolean
        description: 'Enable x86_64-pc-windows-gnu MinGW jobs (manual only)'
        required: false
        default: false
  push:
    branches:
      - test

concurrency:
  group: ${{ github.workflow }}-${{ github.event.pull_request.number || github.ref }}
  cancel-in-progress: true

env:
  LIBRA_REF: "main"
  BUCK2_REV: "c6bfcc629378a00921aa04597551442c9e2ea2eb"
  NIGHTLY_TOOLCHAIN: "nightly-2025-08-01"

jobs:
  # ============================================================
  # Phase 1: Generate Buck2 files on each platform
  # ============================================================
  generate:
    name: generate buck2 files (${{ matrix.os }})
    runs-on: ${{ matrix.os }}
    strategy:
      fail-fast: false
      matrix:
        include:
          - name: linux
            os: ubuntu-24.04
          - name: macos
            os: macos-14
          - name: windows
            os: windows-2022

    steps:
      - name: Enable long paths (Windows)
        if: runner.os == 'Windows'
        shell: pwsh
        run: |
          git config --global core.longpaths true
          git config --global core.autocrlf input
          git config --global core.eol lf
          New-ItemProperty `
            -Path "HKLM:\\SYSTEM\\CurrentControlSet\\Control\\FileSystem" `
            -Name "LongPathsEnabled" `
            -Value 1 `
            -PropertyType DWORD `
            -Force `
            | Out-Null
          "CARGO_HOME=C:\\c" | Out-File -FilePath $env:GITHUB_ENV -Encoding utf8 -Append
          "RUSTUP_HOME=C:\\r" | Out-File -FilePath $env:GITHUB_ENV -Encoding utf8 -Append
          "CARGO_TARGET_DIR=C:\\t" | Out-File -FilePath $env:GITHUB_ENV -Encoding utf8 -Append

      - name: Checkout cargo-buckal
        uses: actions/checkout@v6
        with:
          path: cargo-buckal

      - name: Clone libra ${{ env.LIBRA_REF }}
        shell: bash
        run: |
          git clone --depth 1 --branch "${{ env.LIBRA_REF }}" https://github.com/web3infra-foundation/libra.git libra

      - name: Setup Rust toolchain (stable)
        uses: dtolnay/rust-toolchain@master
        with:
          toolchain: stable

      - name: Setup Python 3.11 (Windows)
        if: runner.os == 'Windows'
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      - name: Install nightly toolchain for Buck2
        shell: bash
        run: |
          rustup toolchain install ${{ env.NIGHTLY_TOOLCHAIN }} -c rust-src -c llvm-tools-preview

      - name: Cache Cargo
        uses: Swatinem/rust-cache@v2
        with:
          workspaces: |
            cargo-buckal -> target
          cache-all-crates: true

      - name: Install Buck2 (Unix)
        if: runner.os != 'Windows'
        shell: bash
        run: |
          cargo +${{ env.NIGHTLY_TOOLCHAIN }} install --git https://github.com/facebook/buck2.git --rev ${{ env.BUCK2_REV }} buck2
          echo "$HOME/.cargo/bin" >> $GITHUB_PATH

      - name: Install Buck2 (Windows)
        if: runner.os == 'Windows'
        shell: pwsh
        run: |
          cargo +${{ env.NIGHTLY_TOOLCHAIN }} install --git https://github.com/facebook/buck2.git --rev ${{ env.BUCK2_REV }} buck2
          "$env:CARGO_HOME\\bin" | Out-File -FilePath $env:GITHUB_PATH -Encoding utf8 -Append

      - name: Install cargo-buckal
        shell: bash
        run: |
          cd cargo-buckal
          cargo install --path .

      - name: Initialize Buck2 in libra
        shell: bash
        run: |
          cd libra
          buck2 init --git

      - name: Generate Buck2 files
        shell: bash
        run: |
          cd libra
          rm -rf toolchains platforms
          cargo buckal migrate --buck2

      - name: Upload generated libra tree
        uses: actions/upload-artifact@v4
        with:
          name: libra-gen-${{ matrix.name }}
          path: libra
          if-no-files-found: error
          include-hidden-files: true

  # ============================================================
  # Phase 2: Test each target against each generated file set
  # 8 targets × 3 gen platforms = 24 jobs
  # ============================================================
  test:
    name: ${{ matrix.target }} / ${{ matrix.gen_platform }}-gen (${{ matrix.os }})${{ matrix.mingw_variant && format(' [{0}]', matrix.mingw_variant) || '' }}
    needs: generate
    runs-on: ${{ matrix.os }}
    env:
      MSYS_NO_PATHCONV: ${{ matrix.os == 'Windows' && '1' || '' }}
    strategy:
      fail-fast: false
      matrix:
        include:
          # ========== aarch64-apple-darwin (macos-14) ==========
          - target: aarch64-apple-darwin
            os: macos-14
            gen_platform: linux
          - target: aarch64-apple-darwin
            os: macos-14
            gen_platform: macos
          - target: aarch64-apple-darwin
            os: macos-14
            gen_platform: windows

          # ========== aarch64-pc-windows-msvc (windows-11-arm) ==========
          - target: aarch64-pc-windows-msvc
            os: windows-11-arm
            gen_platform: linux
            exec_platform_override: "aarch64-pc-windows-msvc"
          - target: aarch64-pc-windows-msvc
            os: windows-11-arm
            gen_platform: macos
            exec_platform_override: "aarch64-pc-windows-msvc"
          - target: aarch64-pc-windows-msvc
            os: windows-11-arm
            gen_platform: windows
            exec_platform_override: "aarch64-pc-windows-msvc"

          # ========== aarch64-unknown-linux-gnu (ubuntu-24.04) ==========
          - target: aarch64-unknown-linux-gnu
            os: ubuntu-24.04
            gen_platform: linux
            setup: sudo apt-get -y update && sudo apt-get -y install gcc-aarch64-linux-gnu g++-aarch64-linux-gnu
          - target: aarch64-unknown-linux-gnu
            os: ubuntu-24.04
            gen_platform: macos
            setup: sudo apt-get -y update && sudo apt-get -y install gcc-aarch64-linux-gnu g++-aarch64-linux-gnu
          - target: aarch64-unknown-linux-gnu
            os: ubuntu-24.04
            gen_platform: windows
            setup: sudo apt-get -y update && sudo apt-get -y install gcc-aarch64-linux-gnu g++-aarch64-linux-gnu

          # ========== i686-pc-windows-msvc (windows-2022) ==========
          - target: i686-pc-windows-msvc
            os: windows-2022
            gen_platform: linux
          - target: i686-pc-windows-msvc
            os: windows-2022
            gen_platform: macos
          - target: i686-pc-windows-msvc
            os: windows-2022
            gen_platform: windows

          # ========== i686-unknown-linux-gnu (ubuntu-24.04) ==========
          - target: i686-unknown-linux-gnu
            os: ubuntu-24.04
            gen_platform: linux
            setup: sudo apt-get -y update && sudo apt-get -y install gcc-i686-linux-gnu g++-i686-linux-gnu
          - target: i686-unknown-linux-gnu
            os: ubuntu-24.04
            gen_platform: macos
            setup: sudo apt-get -y update && sudo apt-get -y install gcc-i686-linux-gnu g++-i686-linux-gnu
          - target: i686-unknown-linux-gnu
            os: ubuntu-24.04
            gen_platform: windows
            setup: sudo apt-get -y update && sudo apt-get -y install gcc-i686-linux-gnu g++-i686-linux-gnu

          # ========== x86_64-pc-windows-gnu (windows-2022) ==========
          - target: x86_64-pc-windows-gnu
            os: windows-2022
            gen_platform: linux
            mingw_variant: no-mingw
          - target: x86_64-pc-windows-gnu
            os: windows-2022
            gen_platform: macos
            mingw_variant: no-mingw
          - target: x86_64-pc-windows-gnu
            os: windows-2022
            gen_platform: windows
            mingw_variant: no-mingw

          # ========== x86_64-pc-windows-msvc (windows-2022) ==========
          - target: x86_64-pc-windows-msvc
            os: windows-2022
            gen_platform: linux
          - target: x86_64-pc-windows-msvc
            os: windows-2022
            gen_platform: macos
          - target: x86_64-pc-windows-msvc
            os: windows-2022
            gen_platform: windows

          # ========== x86_64-unknown-linux-gnu (ubuntu-24.04) ==========
          - target: x86_64-unknown-linux-gnu
            os: ubuntu-24.04
            gen_platform: linux
          - target: x86_64-unknown-linux-gnu
            os: ubuntu-24.04
            gen_platform: macos
          - target: x86_64-unknown-linux-gnu
            os: ubuntu-24.04
            gen_platform: windows

    steps: &test_steps
      # ============================================================
      # Windows-specific setup
      # ============================================================
      - name: Enable long paths (Windows)
        if: runner.os == 'Windows'
        shell: pwsh
        run: |
          git config --global core.longpaths true
          git config --global core.autocrlf input
          git config --global core.eol lf
          New-ItemProperty `
            -Path "HKLM:\\SYSTEM\\CurrentControlSet\\Control\\FileSystem" `
            -Name "LongPathsEnabled" `
            -Value 1 `
            -PropertyType DWORD `
            -Force `
            | Out-Null
          "CARGO_HOME=C:\\c" | Out-File -FilePath $env:GITHUB_ENV -Encoding utf8 -Append
          "RUSTUP_HOME=C:\\r" | Out-File -FilePath $env:GITHUB_ENV -Encoding utf8 -Append
          "CARGO_TARGET_DIR=C:\\t" | Out-File -FilePath $env:GITHUB_ENV -Encoding utf8 -Append

      # ============================================================
      # Download generated libra tree
      # ============================================================
      - name: Download libra-gen-${{ matrix.gen_platform }}
        uses: actions/download-artifact@v4
        with:
          name: libra-gen-${{ matrix.gen_platform }}
          path: libra

      # ============================================================
      # Install cross-compilation prerequisites
      # ============================================================
      - name: Install cross prerequisites
        if: matrix.setup != ''
        shell: bash
        run: ${{ matrix.setup }}

      # ============================================================
      # MSYS2/MinGW setup for windows-gnu targets
      # ============================================================
      - name: Install MSYS2/MinGW (Windows GNU)
        if: matrix.needs_mingw == true
        id: msys2
        uses: msys2/setup-msys2@v2
        with:
          msystem: MINGW64
          update: true
          install: >-
            mingw-w64-x86_64-toolchain

      - name: Add MinGW to PATH
        if: matrix.needs_mingw == true
        shell: pwsh
        run: |
          "${{ steps.msys2.outputs.msys2-location }}\\mingw64\\bin" | Out-File -FilePath $env:GITHUB_PATH -Append -Encoding utf8

      # ============================================================
      # Rust toolchain setup
      # ============================================================
      - name: Setup Rust toolchain (stable)
        uses: dtolnay/rust-toolchain@master
        with:
          toolchain: stable
          targets: ${{ matrix.target }}

      - name: Setup Python 3.11 (Windows)
        if: runner.os == 'Windows'
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      - name: Install nightly toolchain for Buck2
        shell: bash
        run: |
          rustup toolchain install ${{ env.NIGHTLY_TOOLCHAIN }} -c rust-src -c llvm-tools-preview

      - name: Install windows-gnu toolchain
        if: matrix.needs_mingw == true
        shell: bash
        run: |
          rustup toolchain install stable-x86_64-pc-windows-gnu
          rustup target add --toolchain stable x86_64-pc-windows-gnu

      # ============================================================
      # Caching
      # ============================================================
      - name: Cache Cargo
        uses: Swatinem/rust-cache@v2
        with:
          cache-all-crates: true

      # ============================================================
      # Install Buck2
      # ============================================================
      - name: Install Buck2 (Unix)
        if: runner.os != 'Windows'
        shell: bash
        run: |
          cargo +${{ env.NIGHTLY_TOOLCHAIN }} install --git https://github.com/facebook/buck2.git --rev ${{ env.BUCK2_REV }} buck2
          echo "$HOME/.cargo/bin" >> $GITHUB_PATH

      - name: Install Buck2 (Windows)
        if: runner.os == 'Windows'
        shell: pwsh
        run: |
          cargo +${{ env.NIGHTLY_TOOLCHAIN }} install --git https://github.com/facebook/buck2.git --rev ${{ env.BUCK2_REV }} buck2
          "$env:CARGO_HOME\\bin" | Out-File -FilePath $env:GITHUB_PATH -Encoding utf8 -Append

      # ============================================================
      # Show version information
      # ============================================================
      - name: Show version information
        shell: bash
        run: |
          echo "=== Rust ==="
          rustup -V
          rustup toolchain list
          cargo -V
          rustc -V
          echo "=== Buck2 ==="
          buck2 --version || buck2 -V || true
          echo "=== GCC ==="
          gcc --version || true

      # ============================================================
      # Buck2 build
      # ============================================================
      - name: Setup tmate session (debug)
        if: ${{ github.event_name == 'workflow_dispatch' && inputs.debug_enabled && matrix.target == 'x86_64-pc-windows-gnu' && matrix.gen_platform == 'windows' && matrix.mingw_variant == 'mingw' }}
        uses: mxschmitt/action-tmate@v3
        with:
          limit-access-to-actor: true
          msys2-location: ${{ steps.msys2.outputs.msys2-location }}

      - name: Buck2 build (with exec platform override)
        if: matrix.exec_platform_override != ''
        shell: bash
        run: |
          cd libra
          buck2 build //... --target-platforms //platforms:${{ matrix.target }} -c build.execution_platforms=//platforms:${{ matrix.exec_platform_override }}

      - name: Buck2 build
        if: matrix.exec_platform_override == ''
        shell: bash
        run: |
          cd libra
          buck2 build //... --target-platforms //platforms:${{ matrix.target }}

      # ============================================================
      # Buck2 test
      # ============================================================
      - name: Buck2 test (with exec platform override)
        if: matrix.exec_platform_override != ''
        shell: bash
        run: |
          cd libra
          buck2 test //... --target-platforms //platforms:${{ matrix.target }} -c build.execution_platforms=//platforms:${{ matrix.exec_platform_override }}

      - name: Buck2 test
        if: matrix.exec_platform_override == ''
        shell: bash
        run: |
          cd libra
          buck2 test //... --target-platforms //platforms:${{ matrix.target }}

  test-mingw:
    name: ${{ matrix.target }} / ${{ matrix.gen_platform }}-gen (${{ matrix.os }})${{ matrix.mingw_variant && format(' [{0}]', matrix.mingw_variant) || '' }}
    needs: generate
    runs-on: ${{ matrix.os }}
    env:
      MSYS_NO_PATHCONV: ${{ matrix.os == 'Windows' && '1' || '' }}
    if: ${{ github.event_name == 'workflow_dispatch' && github.event.inputs.enable_mingw_jobs == 'true' }}
    continue-on-error: true
    strategy:
      fail-fast: false
      matrix:
        include:
          - target: x86_64-pc-windows-gnu
            os: windows-2022
            gen_platform: linux
            needs_mingw: true
            mingw_variant: mingw
          - target: x86_64-pc-windows-gnu
            os: windows-2022
            gen_platform: macos
            needs_mingw: true
            mingw_variant: mingw
          - target: x86_64-pc-windows-gnu
            os: windows-2022
            gen_platform: windows
            needs_mingw: true
            mingw_variant: mingw
    steps: *test_steps
