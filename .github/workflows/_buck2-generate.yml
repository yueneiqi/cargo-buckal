# Reusable workflow for generating Buck2 files
#
# This workflow:
# 1. Sets up the build environment on 3 platforms (linux/macos/windows)
# 2. Installs cargo-buckal and Buck2
# 3. Generates Buck2 files for the target project
# 4. Uploads artifacts for the test phase

name: Reusable Generate

on:
  workflow_call:
    inputs:
      project_name:
        description: 'Project name for artifact naming (e.g., fd, libra, cargo-buckal)'
        required: true
        type: string
      clone_url:
        description: 'Git URL to clone (leave empty for self-test)'
        required: false
        type: string
        default: ''
      clone_ref:
        description: 'Git ref (branch/tag) to clone'
        required: false
        type: string
        default: 'main'
      project_dir:
        description: 'Directory name for the project (defaults to project_name)'
        required: false
        type: string
        default: ''
      buck2_rev:
        description: 'Buck2 git revision to install'
        required: false
        type: string
        default: 'c6bfcc629378a00921aa04597551442c9e2ea2eb'
      nightly_toolchain:
        description: 'Nightly Rust toolchain version'
        required: false
        type: string
        default: 'nightly-2025-08-01'

jobs:
  generate:
    name: generate (${{ matrix.name }})
    runs-on: ${{ matrix.os }}
    strategy:
      fail-fast: false
      matrix:
        include:
          - name: linux
            os: ubuntu-24.04
          - name: macos
            os: macos-14
          - name: windows
            os: windows-2022

    steps:
      - name: Set cargo target dir
        shell: bash
        run: echo "CARGO_TARGET_DIR=${{ runner.temp }}/cargo-target" >> "$GITHUB_ENV"

      - name: Enable long paths (Windows)
        if: runner.os == 'Windows'
        shell: pwsh
        run: |
          git config --global core.longpaths true
          git config --global core.autocrlf input
          git config --global core.eol lf
          New-ItemProperty `
            -Path "HKLM:\\SYSTEM\\CurrentControlSet\\Control\\FileSystem" `
            -Name "LongPathsEnabled" `
            -Value 1 `
            -PropertyType DWORD `
            -Force `
            | Out-Null
          "CARGO_HOME=C:\\c" | Out-File -FilePath $env:GITHUB_ENV -Encoding utf8 -Append
          "RUSTUP_HOME=C:\\r" | Out-File -FilePath $env:GITHUB_ENV -Encoding utf8 -Append
          "CARGO_TARGET_DIR=C:\\t" | Out-File -FilePath $env:GITHUB_ENV -Encoding utf8 -Append

      - name: Checkout cargo-buckal
        uses: actions/checkout@v6
        with:
          path: cargo-buckal

      - name: Clone ${{ inputs.project_name }} ${{ inputs.clone_ref }}
        if: inputs.clone_url != ''
        shell: bash
        run: |
          git clone --depth 1 --branch "${{ inputs.clone_ref }}" "${{ inputs.clone_url }}" "${{ inputs.project_dir || inputs.project_name }}"

      - name: Setup Rust toolchain (stable)
        uses: dtolnay/rust-toolchain@master
        with:
          toolchain: stable

      - name: Setup Python 3.11 (Windows)
        if: runner.os == 'Windows'
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      - name: Install nightly toolchain for Buck2
        shell: bash
        run: |
          rustup toolchain install ${{ inputs.nightly_toolchain }} -c rust-src -c llvm-tools-preview

      - name: Cache Cargo
        uses: Swatinem/rust-cache@v2
        with:
          workspaces: |
            cargo-buckal -> target
          cache-all-crates: true

      - name: Install Buck2 (Unix)
        if: runner.os != 'Windows'
        shell: bash
        run: |
          cargo +${{ inputs.nightly_toolchain }} install --git https://github.com/facebook/buck2.git --rev ${{ inputs.buck2_rev }} buck2
          echo "$HOME/.cargo/bin" >> $GITHUB_PATH

      - name: Install Buck2 (Windows)
        if: runner.os == 'Windows'
        shell: pwsh
        run: |
          cargo +${{ inputs.nightly_toolchain }} install --git https://github.com/facebook/buck2.git --rev ${{ inputs.buck2_rev }} buck2
          "$env:CARGO_HOME\\bin" | Out-File -FilePath $env:GITHUB_PATH -Encoding utf8 -Append

      - name: Install cargo-buckal
        shell: bash
        run: |
          cd cargo-buckal
          cargo install --locked --path .

      # For external projects, initialize Buck2
      - name: Initialize Buck2
        if: inputs.clone_url != ''
        shell: bash
        run: |
          cd "${{ inputs.project_dir || inputs.project_name }}"
          buck2 init --git

      - name: Generate Buck2 files
        shell: bash
        run: |
          cd "${{ inputs.project_dir || inputs.project_name || 'cargo-buckal' }}"
          rm -rf toolchains platforms
          cargo buckal migrate --buck2

      - name: Upload generated tree
        uses: actions/upload-artifact@v4
        with:
          name: ${{ inputs.project_name }}-gen-${{ matrix.name }}
          path: ${{ inputs.project_dir || inputs.project_name || 'cargo-buckal' }}
          if-no-files-found: error
          include-hidden-files: true
