# Reusable workflow for testing Buck2 builds across platforms
#
# This workflow:
# 1. Downloads generated artifacts from the generate phase
# 2. Sets up cross-compilation toolchains
# 3. Builds and optionally tests with Buck2

name: Reusable Test

on:
  workflow_call:
    inputs:
      project_name:
        description: 'Project name for artifact naming (e.g., fd, libra, cargo-buckal)'
        required: true
        type: string
      project_dir:
        description: 'Directory name for the project (defaults to project_name)'
        required: false
        type: string
        default: ''
      build_target:
        description: 'Buck2 build target (e.g., "//:fd" or "//...")'
        required: false
        type: string
        default: '//...'
      run_tests:
        description: 'Whether to run buck2 test after build'
        required: false
        type: boolean
        default: true
      debug_enabled:
        description: 'Enable tmate debug session'
        required: false
        type: boolean
        default: false
      enable_mingw_jobs:
        description: 'Enable x86_64-pc-windows-gnu MinGW jobs'
        required: false
        type: boolean
        default: false
      buck2_rev:
        description: 'Buck2 git revision to install'
        required: false
        type: string
        default: 'c6bfcc629378a00921aa04597551442c9e2ea2eb'
      nightly_toolchain:
        description: 'Nightly Rust toolchain version'
        required: false
        type: string
        default: 'nightly-2025-08-01'

jobs:
  test:
    name: ${{ matrix.target }} / ${{ matrix.gen_platform }}-gen (${{ matrix.os }})${{ matrix.mingw_variant && format(' [{0}]', matrix.mingw_variant) || '' }}
    runs-on: ${{ matrix.os }}
    env:
      MSYS_NO_PATHCONV: ${{ matrix.os == 'Windows' && '1' || '' }}
    strategy:
      fail-fast: false
      matrix:
        include:
          # ========== aarch64-apple-darwin (macos-14) ==========
          - target: aarch64-apple-darwin
            os: macos-14
            gen_platform: linux
          - target: aarch64-apple-darwin
            os: macos-14
            gen_platform: macos
          - target: aarch64-apple-darwin
            os: macos-14
            gen_platform: windows

          # ========== aarch64-pc-windows-msvc (windows-11-arm) ==========
          - target: aarch64-pc-windows-msvc
            os: windows-11-arm
            gen_platform: linux
            exec_platform_override: "aarch64-pc-windows-msvc"
          - target: aarch64-pc-windows-msvc
            os: windows-11-arm
            gen_platform: macos
            exec_platform_override: "aarch64-pc-windows-msvc"
          - target: aarch64-pc-windows-msvc
            os: windows-11-arm
            gen_platform: windows
            exec_platform_override: "aarch64-pc-windows-msvc"

          # ========== aarch64-unknown-linux-gnu (ubuntu-24.04) ==========
          - target: aarch64-unknown-linux-gnu
            os: ubuntu-24.04
            gen_platform: linux
            setup: sudo apt-get -y update && sudo apt-get -y install gcc-aarch64-linux-gnu g++-aarch64-linux-gnu
          - target: aarch64-unknown-linux-gnu
            os: ubuntu-24.04
            gen_platform: macos
            setup: sudo apt-get -y update && sudo apt-get -y install gcc-aarch64-linux-gnu g++-aarch64-linux-gnu
          - target: aarch64-unknown-linux-gnu
            os: ubuntu-24.04
            gen_platform: windows
            setup: sudo apt-get -y update && sudo apt-get -y install gcc-aarch64-linux-gnu g++-aarch64-linux-gnu

          # ========== i686-pc-windows-msvc (windows-2022) ==========
          - target: i686-pc-windows-msvc
            os: windows-2022
            gen_platform: linux
          - target: i686-pc-windows-msvc
            os: windows-2022
            gen_platform: macos
          - target: i686-pc-windows-msvc
            os: windows-2022
            gen_platform: windows

          # ========== i686-unknown-linux-gnu (ubuntu-24.04) ==========
          - target: i686-unknown-linux-gnu
            os: ubuntu-24.04
            gen_platform: linux
            setup: sudo apt-get -y update && sudo apt-get -y install gcc-i686-linux-gnu g++-i686-linux-gnu
          - target: i686-unknown-linux-gnu
            os: ubuntu-24.04
            gen_platform: macos
            setup: sudo apt-get -y update && sudo apt-get -y install gcc-i686-linux-gnu g++-i686-linux-gnu
          - target: i686-unknown-linux-gnu
            os: ubuntu-24.04
            gen_platform: windows
            setup: sudo apt-get -y update && sudo apt-get -y install gcc-i686-linux-gnu g++-i686-linux-gnu

          # ========== x86_64-pc-windows-gnu (windows-2022) [no-mingw] ==========
          - target: x86_64-pc-windows-gnu
            os: windows-2022
            gen_platform: linux
            mingw_variant: no-mingw
          - target: x86_64-pc-windows-gnu
            os: windows-2022
            gen_platform: macos
            mingw_variant: no-mingw
          - target: x86_64-pc-windows-gnu
            os: windows-2022
            gen_platform: windows
            mingw_variant: no-mingw

          # ========== x86_64-pc-windows-msvc (windows-2022) ==========
          - target: x86_64-pc-windows-msvc
            os: windows-2022
            gen_platform: linux
          - target: x86_64-pc-windows-msvc
            os: windows-2022
            gen_platform: macos
          - target: x86_64-pc-windows-msvc
            os: windows-2022
            gen_platform: windows

          # ========== x86_64-unknown-linux-gnu (ubuntu-24.04) ==========
          - target: x86_64-unknown-linux-gnu
            os: ubuntu-24.04
            gen_platform: linux
          - target: x86_64-unknown-linux-gnu
            os: ubuntu-24.04
            gen_platform: macos
          - target: x86_64-unknown-linux-gnu
            os: ubuntu-24.04
            gen_platform: windows

    steps: &test_steps
      - name: Set cargo target dir
        shell: bash
        run: echo "CARGO_TARGET_DIR=${{ runner.temp }}/cargo-target" >> "$GITHUB_ENV"

      # ============================================================
      # Windows-specific setup
      # ============================================================
      - name: Enable long paths (Windows)
        if: runner.os == 'Windows'
        shell: pwsh
        run: |
          git config --global core.longpaths true
          git config --global core.autocrlf input
          git config --global core.eol lf
          New-ItemProperty `
            -Path "HKLM:\\SYSTEM\\CurrentControlSet\\Control\\FileSystem" `
            -Name "LongPathsEnabled" `
            -Value 1 `
            -PropertyType DWORD `
            -Force `
            | Out-Null
          "CARGO_HOME=C:\\c" | Out-File -FilePath $env:GITHUB_ENV -Encoding utf8 -Append
          "RUSTUP_HOME=C:\\r" | Out-File -FilePath $env:GITHUB_ENV -Encoding utf8 -Append
          "CARGO_TARGET_DIR=C:\\t" | Out-File -FilePath $env:GITHUB_ENV -Encoding utf8 -Append

      # ============================================================
      # Download generated tree
      # ============================================================
      - name: Download ${{ inputs.project_name }}-gen-${{ matrix.gen_platform }}
        uses: actions/download-artifact@v4
        with:
          name: ${{ inputs.project_name }}-gen-${{ matrix.gen_platform }}
          path: ${{ inputs.project_dir || inputs.project_name }}

      # ============================================================
      # Install cross-compilation prerequisites
      # ============================================================
      - name: Install cross prerequisites
        if: matrix.setup != ''
        shell: bash
        run: ${{ matrix.setup }}

      # ============================================================
      # MSYS2/MinGW setup for windows-gnu targets
      # ============================================================
      - name: Install MSYS2/MinGW (Windows GNU)
        if: matrix.needs_mingw == true
        id: msys2
        uses: msys2/setup-msys2@v2
        with:
          msystem: MINGW64
          update: true
          install: >-
            mingw-w64-x86_64-toolchain

      - name: Add MinGW to PATH
        if: matrix.needs_mingw == true
        shell: pwsh
        run: |
          "${{ steps.msys2.outputs.msys2-location }}\\mingw64\\bin" | Out-File -FilePath $env:GITHUB_PATH -Append -Encoding utf8

      # ============================================================
      # Rust toolchain setup
      # ============================================================
      - name: Setup Rust toolchain (stable)
        uses: dtolnay/rust-toolchain@master
        with:
          toolchain: stable
          targets: ${{ matrix.target }}

      - name: Setup Python 3.11 (Windows)
        if: runner.os == 'Windows'
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      - name: Install nightly toolchain for Buck2
        shell: bash
        run: |
          rustup toolchain install ${{ inputs.nightly_toolchain }} -c rust-src -c llvm-tools-preview

      - name: Install windows-gnu toolchain
        if: matrix.needs_mingw == true
        shell: bash
        run: |
          rustup toolchain install stable-x86_64-pc-windows-gnu
          rustup target add --toolchain stable x86_64-pc-windows-gnu

      # ============================================================
      # Caching
      # ============================================================
      - name: Cache Cargo
        uses: Swatinem/rust-cache@v2
        with:
          cache-all-crates: true

      # ============================================================
      # Install Buck2
      # ============================================================
      - name: Install Buck2 (Unix)
        if: runner.os != 'Windows'
        shell: bash
        run: |
          cargo +${{ inputs.nightly_toolchain }} install --git https://github.com/facebook/buck2.git --rev ${{ inputs.buck2_rev }} buck2
          echo "$HOME/.cargo/bin" >> $GITHUB_PATH

      - name: Install Buck2 (Windows)
        if: runner.os == 'Windows'
        shell: pwsh
        run: |
          cargo +${{ inputs.nightly_toolchain }} install --git https://github.com/facebook/buck2.git --rev ${{ inputs.buck2_rev }} buck2
          "$env:CARGO_HOME\\bin" | Out-File -FilePath $env:GITHUB_PATH -Encoding utf8 -Append

      # ============================================================
      # Show version information
      # ============================================================
      - name: Show version information
        shell: bash
        run: |
          echo "=== Rust ==="
          rustup -V
          rustup toolchain list
          cargo -V
          rustc -V
          echo "=== Buck2 ==="
          buck2 --version || buck2 -V || true
          echo "=== GCC ==="
          gcc --version || true

      # ============================================================
      # Buck2 build
      # ============================================================
      - name: Setup tmate session (debug)
        if: ${{ inputs.debug_enabled && matrix.target == 'x86_64-pc-windows-gnu' && matrix.gen_platform == 'windows' && matrix.mingw_variant == 'mingw' }}
        uses: mxschmitt/action-tmate@v3
        with:
          limit-access-to-actor: true
          msys2-location: ${{ steps.msys2.outputs.msys2-location }}

      - name: Buck2 build (with exec platform override)
        if: matrix.exec_platform_override != ''
        shell: bash
        run: |
          cd "${{ inputs.project_dir || inputs.project_name }}"
          buck2 build ${{ inputs.build_target }} --target-platforms //platforms:${{ matrix.target }} -c build.execution_platforms=//platforms:${{ matrix.exec_platform_override }}

      - name: Buck2 build
        if: matrix.exec_platform_override == ''
        shell: bash
        run: |
          cd "${{ inputs.project_dir || inputs.project_name }}"
          buck2 build ${{ inputs.build_target }} --target-platforms //platforms:${{ matrix.target }}

      # ============================================================
      # Buck2 test
      # ============================================================
      - name: Buck2 test (with exec platform override)
        if: inputs.run_tests && matrix.exec_platform_override != ''
        shell: bash
        run: |
          cd "${{ inputs.project_dir || inputs.project_name }}"
          buck2 test //... --target-platforms //platforms:${{ matrix.target }} -c build.execution_platforms=//platforms:${{ matrix.exec_platform_override }}

      - name: Buck2 test
        if: inputs.run_tests && matrix.exec_platform_override == ''
        shell: bash
        run: |
          cd "${{ inputs.project_dir || inputs.project_name }}"
          buck2 test //... --target-platforms //platforms:${{ matrix.target }}

  test-mingw:
    name: ${{ matrix.target }} / ${{ matrix.gen_platform }}-gen (${{ matrix.os }})${{ matrix.mingw_variant && format(' [{0}]', matrix.mingw_variant) || '' }}
    runs-on: ${{ matrix.os }}
    env:
      MSYS_NO_PATHCONV: ${{ matrix.os == 'Windows' && '1' || '' }}
    if: ${{ inputs.enable_mingw_jobs }}
    continue-on-error: true
    strategy:
      fail-fast: false
      matrix:
        include:
          - target: x86_64-pc-windows-gnu
            os: windows-2022
            gen_platform: linux
            needs_mingw: true
            mingw_variant: mingw
          - target: x86_64-pc-windows-gnu
            os: windows-2022
            gen_platform: macos
            needs_mingw: true
            mingw_variant: mingw
          - target: x86_64-pc-windows-gnu
            os: windows-2022
            gen_platform: windows
            needs_mingw: true
            mingw_variant: mingw
    steps: *test_steps
