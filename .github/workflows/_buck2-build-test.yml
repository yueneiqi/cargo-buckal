# Reusable workflow for testing Buck2 builds across platforms
#
# This workflow:
# 1. Downloads generated artifacts from the generate phase
# 2. Sets up cross-compilation toolchains
# 3. Builds and optionally tests with cargo buckal

name: Build and Test Buck2

on:
  workflow_call:
    inputs:
      project_name:
        description: 'Project name for artifact naming (e.g., fd, libra, cargo-buckal)'
        required: true
        type: string
      project_dir:
        description: 'Directory name for the project (defaults to project_name)'
        required: false
        type: string
        default: ''
      build_target:
        description: 'Buck2 build target (e.g., "//:fd" or "//...")'
        required: false
        type: string
        default: '//...'
      run_tests:
        description: 'Whether to run buck2 test after build'
        required: false
        type: boolean
        default: true
      debug_enabled:
        description: 'Enable tmate debug session'
        required: false
        type: boolean
        default: false

jobs:
  test:
    name: ${{ matrix.target }} (${{ matrix.os }})
    runs-on: ${{ matrix.os }}
    env:
      MSYS_NO_PATHCONV: ${{ matrix.os == 'Windows' && '1' || '' }}
    strategy:
      fail-fast: false
      matrix:
        include:
          # Since generated Buck2 files are identical across platforms (verified by _buck2-verify-cross-platform.yml),
          # we only need to test one generated artifact per target platform.
          - target: aarch64-apple-darwin
            os: macos-14
          - target: x86_64-pc-windows-msvc
            os: windows-2022
          - target: x86_64-unknown-linux-gnu
            os: ubuntu-24.04

    steps:
      - name: Set cargo target dir
        shell: bash
        run: echo "CARGO_TARGET_DIR=${{ runner.temp }}/cargo-target" >> "$GITHUB_ENV"

      # ============================================================
      # Checkout cargo-buckal for reusable actions
      # ============================================================
      - name: Checkout cargo-buckal (for actions)
        uses: actions/checkout@v6
        with:
          path: cargo-buckal
          sparse-checkout: .github/actions

      # ============================================================
      # Checkout cargo-buckal source for installation
      # ============================================================
      - name: Checkout cargo-buckal (for installation)
        uses: actions/checkout@v6
        with:
          path: cargo-buckal-src

      # ============================================================
      # Windows-specific setup
      # ============================================================
      - name: Setup Windows environment
        uses: ./cargo-buckal/.github/actions/setup-windows

      # ============================================================
      # Download generated tree
      # ============================================================
      - name: Download ${{ inputs.project_name }}-gen-linux
        uses: actions/download-artifact@v4
        with:
          name: ${{ inputs.project_name }}-gen-linux
          path: ${{ inputs.project_dir || inputs.project_name }}

      # ============================================================
      # Rust toolchain setup
      # ============================================================
      - name: Setup Rust toolchains
        uses: ./cargo-buckal/.github/actions/setup-rust-toolchains
        with:
          targets: ${{ matrix.target }}

      # ============================================================
      # Caching
      # ============================================================
      - name: Cache Cargo
        uses: Swatinem/rust-cache@v2
        with:
          cache-all-crates: true

      # ============================================================
      # Install Buck2
      # ============================================================
      - name: Install Buck2
        uses: ./cargo-buckal/.github/actions/install-buck2

      # ============================================================
      # Install cargo-buckal
      # ============================================================
      - name: Install cargo-buckal
        shell: bash
        run: |
          cd cargo-buckal-src
          cargo install --locked --path .

      # ============================================================
      # Show version information
      # ============================================================
      - name: Show version information
        shell: bash
        run: |
          echo "=== Rust ==="
          rustup -V
          rustup toolchain list
          cargo -V
          rustc -V
          echo "=== Buck2 ==="
          buck2 --version || buck2 -V || true
          echo "=== cargo-buckal ==="
          cargo buckal --version || true
          echo "=== GCC ==="
          gcc --version || true

      # ============================================================
      # cargo buckal build
      # ============================================================
      - name: cargo buckal build
        shell: bash
        run: |
          cd "${{ inputs.project_dir || inputs.project_name }}"
          cargo buckal build --all-targets
      - name: cargo buckal build (target-platforms)
        shell: bash
        run: |
          cd "${{ inputs.project_dir || inputs.project_name }}"
          cargo buckal build --all-targets --target-platforms //platforms:${{ matrix.target }}

      # ============================================================
      # cargo buckal test
      # ============================================================
      - name: cargo buckal test
        if: inputs.run_tests
        shell: bash
        run: |
          cd "${{ inputs.project_dir || inputs.project_name }}"
          cargo buckal test --workspace
      - name: cargo buckal test (target-platforms)
        if: inputs.run_tests
        shell: bash
        run: |
          cd "${{ inputs.project_dir || inputs.project_name }}"
          cargo buckal test --workspace --target-platforms //platforms:${{ matrix.target }}
